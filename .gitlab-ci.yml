image: node:10

stages:
    - testBuild
    - testDeploy
    - testRun

.only_default: &only_default
    only:
        - staging
        - tags

testBuild:
    <<: *only_default
    stage: testBuild
    script: 
        - yarn install
        - yarn build
    artifacts:
      paths:
        - build/
        - node_modules/ 
      expire_in: 1 hr

testDeploy:
    <<: *only_default
    stage: testDeploy
    before_script:
      - npm i -g firebase-tools 
    script:
      - dir
      - firebase target:apply hosting 123 production --token=$FIREBASE_TOKEN
    dependencies:
      - testBuild

testRun:
    <<: *only_default
    stage: testRun
    artifacts:
        name: "$CI_PROJECT_NAME-$CI_COMMIT_REF_NAME-TEST"
        paths:
            - __tests__/reports.json
        expire_in: 7 days
    services:
        - selenium/standalone-chrome
    script:
        - yarn test:reports
    dependencies:
        - testBuild