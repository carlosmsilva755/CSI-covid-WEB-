image: node:10

stages:
    - testBuild
    - testDeploy
    - testRun

.only_default: &only_default
    only:
        - staging
        - tags

testBuild:
    <<: *only_default
    stage: testBuild
    # before_script:
    #   - apt-get --quiet update --yes
    #   - curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
    #   - echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
    #   - apt-get --quiet install yarn --yes
    #   - yarn --version 
    script: 
        - yarn install
        - yarn build
    artifacts:
      paths:
        - build/
        - node_modules/ 
      expire_in: 1 hr

testDeploy:
    <<: *only_default
    stage: testDeploy
    before_script:
      - npm i -g firebase-tools 
    script:
      - dir
      - firebase deploy --token=$FIREBASE_TOKEN 
    dependencies:
      - testBuild

testRun:
    <<: *only_default
    stage: testRun
    artifacts:
        name: "$CI_PROJECT_NAME-$CI_COMMIT_REF_NAME-TEST"
        paths:
            - __tests__/reports.json
        expire_in: 7 days
    services:
        - selenium/standalone-chrome
    # before_script:
    #     - apt-get --quiet update --yes
    #     - curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
    #     - echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
    #     - apt-get --quiet install yarn --yes
        # - cd __tests__
        # #- curl https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb -o /chrome.deb
        # #- dpkg -i /chrome.deb || apt-get install -yf
        # #- rm /chrome.deb
        # - yarn add chromedriver@81.0.0
        # - yarn add cucumber
    script:
        - yarn test:reports
        # - chcp 65001 && cuke --run --format html --browser Chrome login.feature logout.feature comment.feature
    dependencies:
        - testBuild

